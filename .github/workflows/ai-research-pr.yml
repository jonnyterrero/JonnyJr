name: AI Research & PR
on:
  workflow_dispatch:
    inputs:
      topic:
        description: "What should Perplexity research?"
        required: true
      branch:
        description: "Note: Uses workflow/ai-research-pr branch (this field is for reference only)"
        required: false
        default: "workflow/ai-research-pr"
jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: "20" }

      - name: Install deps
        run: |
          npm install
          cd packages/ts && npm install

      - name: Research with Perplexity
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
        run: |
          npx ts-node scripts/research.ts "${{ github.event.inputs.topic }}" > RESEARCH.md

      - name: Synthesize with OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          npx ts-node scripts/synthesize.ts RESEARCH.md > SYNTHESIS.md

      - name: Create/Update workflow branch and commit
        run: |
          # Use consistent branch name for this workflow
          BRANCH_NAME="workflow/ai-research-pr"
          echo "üì¶ Using branch: $BRANCH_NAME"
          
          # Configure git
          git config --global user.name 'ci'
          git config --global user.email 'ci@users.noreply.github.com'
          
          # Fetch all branches
          git fetch origin || true
          
          # Remove local branch if it exists (clean slate)
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          
          # Checkout existing remote branch or create new one
          if git show-ref --verify --quiet refs/remotes/origin/"$BRANCH_NAME"; then
            echo "‚úÖ Branch exists remotely, checking out..."
            git checkout -b "$BRANCH_NAME" "origin/$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          else
            echo "üÜï Creating new branch from main..."
            git checkout -b "$BRANCH_NAME" main || git checkout -b "$BRANCH_NAME"
          fi
          
          git add RESEARCH.md SYNTHESIS.md
          git commit -m "AI: research & synthesis for ${{ github.event.inputs.topic }}" || {
            echo "‚ÑπÔ∏è  No changes to commit (files may be unchanged)"
          }
          
          # Configure remote with PAT
          git remote remove origin || true
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Push to update the branch
          git push --force-with-lease origin "$BRANCH_NAME" || git push --force origin "$BRANCH_NAME"
          echo "‚úÖ Updated branch: $BRANCH_NAME"
          
          # Store branch name for PR creation
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create or Update PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for existing PR on branch: $BRANCH_NAME"
          
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "‚úÖ PR #$EXISTING_PR already exists, updating..."
            gh pr edit "$EXISTING_PR" \
              --title "AI: ${{ github.event.inputs.topic }}" \
              --body-file SYNTHESIS.md 2>/dev/null || true
            echo "‚úÖ PR #$EXISTING_PR updated"
          else
            echo "üÜï Creating new PR..."
            if gh pr create \
              --title "AI: ${{ github.event.inputs.topic }}" \
              --body-file SYNTHESIS.md \
              --base main \
              --head "$BRANCH_NAME" 2>/dev/null; then
              echo "‚úÖ PR created successfully"
            else
              echo "‚ö†Ô∏è  Could not create PR automatically. Please create manually:"
              echo "   Branch: $BRANCH_NAME"
              echo "   URL: https://github.com/${{ github.repository }}/compare/main...$BRANCH_NAME"
            fi
          fi
