name: AI Research Workflow

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Research topic (e.g., "biomaterials synthesis", "differential equations")'
        required: true
        default: 'repo roadmap and improvements'
      category:
        description: 'Research category'
        required: false
        default: 'Personal Projects'
        type: choice
        options:
          - 'Personal Projects'
          - 'Reflections & Questions'
          - 'Math & Coding'
          - 'Sciences'

jobs:
  research:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        cd packages/ts && npm install
      
    - name: Run research script
      env:
        PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        npx ts-node scripts/research.ts "${{ github.event.inputs.topic }}"
        
    - name: Configure git
      env:
        ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
      run: |
        if [ -z "$ACTIONS_PAT" ]; then
          echo "ACTIONS_PAT is not set; skipping commit" >&2
          exit 0
        fi
        git config --global --unset-all http.https://github.com/.extraheader || true
        git config --local --unset-all http.https://github.com/.extraheader || true
        git config --global user.name "${GITHUB_ACTOR}"
        git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
        git remote remove origin || true
        git remote add origin https://${GITHUB_ACTOR}:${{ secrets.ACTIONS_PAT }}@github.com/${{ github.repository }}.git
        
    - name: Commit research results
      env:
        ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
      run: |
        if [ -z "$ACTIONS_PAT" ]; then
          echo "‚ö†Ô∏è  ACTIONS_PAT not set. Research results saved but not committed."
          echo "To commit automatically, add ACTIONS_PAT secret to repository."
          exit 0
        fi
        
        # Use consistent branch name for this workflow
        BRANCH_NAME="workflow/ai-research"
        echo "üì¶ Using branch: $BRANCH_NAME"
        
        # Fetch all branches
        git fetch origin || true
        
        # Remove local branch if it exists (clean slate)
        git branch -D "$BRANCH_NAME" 2>/dev/null || true
        
        # Checkout existing remote branch or create new one
        if git show-ref --verify --quiet refs/remotes/origin/"$BRANCH_NAME"; then
          echo "‚úÖ Branch exists remotely, checking out..."
          git checkout -b "$BRANCH_NAME" "origin/$BRANCH_NAME" || git checkout "$BRANCH_NAME"
        else
          echo "üÜï Creating new branch from main..."
          git checkout -b "$BRANCH_NAME" main || git checkout -b "$BRANCH_NAME"
        fi
        
        git add RESEARCH.md || true
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit (file may be unchanged)"
          exit 0
        fi
        
        git commit -m "Research: ${{ github.event.inputs.topic }} [Category: ${{ github.event.inputs.category }}]" || exit 0
        git push --force-with-lease origin "$BRANCH_NAME" || git push --force origin "$BRANCH_NAME" || exit 0
        
        echo "‚úÖ Research committed to branch: $BRANCH_NAME"
