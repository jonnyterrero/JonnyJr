name: Art Inspiration

on:
  workflow_dispatch:
    inputs:
      style:
        description: "Art style or medium (e.g., digital painting, watercolor, sculpture)"
        required: true
      prompt:
        description: "Describe your concept/question"
        required: true
      category:
        description: "Category"
        required: true
        default: "Personal Projects"
        type: choice
        options:
          - "Personal Projects"
          - "Reflections & Questions"
          - "Math & Coding"
          - "Sciences"

permissions:
  contents: write
  pull-requests: write

jobs:
  art_help:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Don't persist credentials; we'll inject PAT explicitly for pushes
          persist-credentials: false
          fetch-depth: 0
      - name: Configure git to use ACTIONS_PAT for all GitHub HTTPS operations
        env:
          ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
        run: |
          if [ -z "$ACTIONS_PAT" ]; then
            echo "ACTIONS_PAT is not set; failing fast" >&2
            exit 1
          fi
          # Ensure no leftover GitHub Actions auth header is present
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --local --unset-all http.https://github.com/.extraheader || true
          # Route all https://github.com URLs through PAT-authenticated URL
          git config --global url."https://x-access-token:$ACTIONS_PAT@github.com/".insteadOf "https://github.com/"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: npm ci || npm i
      - name: Research art prompt
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
        run: |
          npx ts-node scripts/research.ts "Art style: ${{ github.event.inputs.style }}, Prompt: ${{ github.event.inputs.prompt }}" > RESEARCH.md
      - name: Synthesize inspiration/execution plan
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          npx ts-node scripts/synthesize.ts RESEARCH.md > SYNTHESIS.md
      - name: Upload outputs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: art-inspiration-outputs
          path: |
            RESEARCH.md
            SYNTHESIS.md
      - name: Create/Update workflow branch and commit
        run: |
          # Use consistent branch name for this workflow
          BRANCH_NAME="workflow/art-inspiration"
          echo "üì¶ Using branch: $BRANCH_NAME"
          
          # Fetch to check if branch exists remotely
          git fetch origin "$BRANCH_NAME" 2>/dev/null || true
          
          # Checkout existing branch or create new one
          if git show-ref --verify --quiet refs/remotes/origin/"$BRANCH_NAME"; then
            echo "‚úÖ Branch exists remotely, checking out..."
            git checkout -B "$BRANCH_NAME" "origin/$BRANCH_NAME"
          else
            echo "üÜï Creating new branch..."
            git checkout -b "$BRANCH_NAME"
          fi
          
          git add RESEARCH.md SYNTHESIS.md
          git -c user.name='ci' -c user.email='ci@users.noreply.github.com' commit -m "Art Inspiration: ${{ github.event.inputs.style }} - ${{ github.event.inputs.prompt }}" || {
            echo "‚ÑπÔ∏è  No changes to commit (files may be unchanged)"
          }
          
          # Ensure origin uses PAT explicitly
          git remote remove origin || true
          git remote add origin https://x-access-token:${{ secrets.ACTIONS_PAT }}@github.com/${{ github.repository }}.git
          git ls-remote --heads origin >/dev/null 2>&1 || true

          # Push to update the branch
          git push --force-with-lease origin "$BRANCH_NAME" || git push --force origin "$BRANCH_NAME"
          echo "‚úÖ Updated branch: $BRANCH_NAME"
          
          # Store branch name for PR creation
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      - name: Create or Update PR
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_PAT }}
        run: |
          echo "üîç Checking for existing PR on branch: $BRANCH_NAME"
          
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "‚úÖ PR #$EXISTING_PR already exists, updating..."
            gh pr edit "$EXISTING_PR" \
              --title "Art Help: ${{ github.event.inputs.style }} - ${{ github.event.inputs.prompt }}" \
              --body-file SYNTHESIS.md \
              --add-label "${{ github.event.inputs.category }}" 2>/dev/null || true
            echo "‚úÖ PR #$EXISTING_PR updated"
          else
            echo "üÜï Creating new PR..."
            if gh pr create \
              --title "Art Help: ${{ github.event.inputs.style }} - ${{ github.event.inputs.prompt }}" \
              --body-file SYNTHESIS.md \
              --base main \
              --head "$BRANCH_NAME" \
              --label "${{ github.event.inputs.category }}" 2>/dev/null; then
              echo "‚úÖ PR created successfully"
            else
              echo "‚ö†Ô∏è  Could not create PR automatically. Please create manually:"
              echo "   Branch: $BRANCH_NAME"
              echo "   URL: https://github.com/${{ github.repository }}/compare/main...$BRANCH_NAME"
            fi
          fi
