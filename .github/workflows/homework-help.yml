name: Homework Help

on:
  workflow_dispatch:
    inputs:
      course:
        description: "Course name (e.g., MAP2302, Biomed, Chem101, CS50)"
        required: true
      assignment:
        description: "Assignment task (e.g., HW1 - Laplace)"
        required: true
      category:
        description: "Category"
        required: true
        default: "Math & Coding"
        type: choice
        options:
          - "Personal Projects"
          - "Reflections & Questions"
          - "Math & Coding"
          - "Sciences"

permissions:
  contents: write
  pull-requests: write

jobs:
  hw_help:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: npm ci || npm i
      - name: Configure git to use ACTIONS_PAT
        env:
          ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
        run: |
          if [ -z "$ACTIONS_PAT" ]; then
            echo "ACTIONS_PAT is not set; failing" >&2
            exit 1
          fi
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --local --unset-all http.https://github.com/.extraheader || true
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
      - name: Prepare directory structure
        run: |
          # Extract course code (e.g., MAP2302, BME3100C) from input
          COURSE_CODE="${{ github.event.inputs.course }}"
          ASSIGNMENT="${{ github.event.inputs.assignment }}"
          
          # Normalize assignment name (remove spaces, special chars for directory)
          ASSIGNMENT_DIR=$(echo "$ASSIGNMENT" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          
          # Create directory structure
          SCHOOL_DIR="school/$COURSE_CODE/$ASSIGNMENT_DIR"
          mkdir -p "$SCHOOL_DIR"
          
          echo "SCHOOL_DIR=$SCHOOL_DIR" >> $GITHUB_ENV
          echo "COURSE_CODE=$COURSE_CODE" >> $GITHUB_ENV
          echo "ASSIGNMENT_DIR=$ASSIGNMENT_DIR" >> $GITHUB_ENV
          
          echo "üìÅ Created directory: $SCHOOL_DIR"
      - name: Research assignment
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
        run: |
          echo "üî¨ Researching: ${{ github.event.inputs.course }} - ${{ github.event.inputs.assignment }}"
          echo "üìö This may take 30-60 seconds..."
          npx ts-node scripts/research.ts "${{ github.event.inputs.course }} ${{ github.event.inputs.assignment }} homework help" > RESEARCH.md || {
            echo "‚ö†Ô∏è  Research script had issues, but continuing..."
            touch RESEARCH.md
          }
          echo "‚úÖ Research complete"
      - name: Synthesize plan
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ü§ñ Synthesizing research into actionable plan..."
          echo "‚è≥ This may take 20-40 seconds..."
          npx ts-node scripts/synthesize.ts RESEARCH.md > SYNTHESIS.md || {
            echo "‚ö†Ô∏è  Synthesis script had issues, but continuing..."
            echo "# Synthesis\n\nSee RESEARCH.md for details." > SYNTHESIS.md
          }
          echo "‚úÖ Synthesis complete"
      - name: Create README and move files
        run: |
          # Move research and synthesis to course directory
          cp RESEARCH.md "$SCHOOL_DIR/"
          cp SYNTHESIS.md "$SCHOOL_DIR/"
          
          # Create a README.md in the assignment directory
          cat > "$SCHOOL_DIR/README.md" << EOF
          # ${{ github.event.inputs.course }} ‚Äî ${{ github.event.inputs.assignment }}
          
          **Category**: ${{ github.event.inputs.category }}  
          **Created**: $(date -u +"%Y-%m-%d %H:%M UTC")
          
          ## Files
          - \`RESEARCH.md\` - Research findings and sources
          - \`SYNTHESIS.md\` - Actionable plan and next steps
          
          ## Quick Reference
          See \`SYNTHESIS.md\` for:
          - Direct answers and solution approach
          - Step-by-step next actions
          - Materials and tools needed
          - Common pitfalls and mitigations
          - References and textbooks
          
          ---
          *Generated by JonnyJr Homework Help workflow*
          EOF
          
          echo "üìÑ Created README.md in $SCHOOL_DIR"
      - name: Upload outputs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: homework-help-outputs
          path: |
            ${{ env.SCHOOL_DIR }}/RESEARCH.md
            ${{ env.SCHOOL_DIR }}/SYNTHESIS.md
            ${{ env.SCHOOL_DIR }}/README.md
      - name: Create/Update workflow branch and commit
        run: |
          # Use consistent branch name for this workflow
          BRANCH_NAME="workflow/homework-help"
          echo "üì¶ Using branch: $BRANCH_NAME"
          
          # Fetch all branches
          git fetch origin || true
          
          # Remove local branch if it exists (clean slate)
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          
          # Checkout existing remote branch or create new one
          if git show-ref --verify --quiet refs/remotes/origin/"$BRANCH_NAME"; then
            echo "‚úÖ Branch exists remotely, checking out..."
            git checkout -b "$BRANCH_NAME" "origin/$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          else
            echo "üÜï Creating new branch from main..."
            git checkout -b "$BRANCH_NAME" main || git checkout -b "$BRANCH_NAME"
          fi
          
          # Add and commit changes
          git add "$SCHOOL_DIR/"
          git -c user.name='ci' -c user.email='ci@users.noreply.github.com' commit -m "Homework help: ${{ github.event.inputs.course }} ${{ github.event.inputs.assignment }}" || {
            echo "‚ÑπÔ∏è  No changes to commit (files may be unchanged)"
          }
          
          # Ensure PAT-based origin using actor:token form
          git remote remove origin || true
          git remote add origin https://${GITHUB_ACTOR}:${{ secrets.ACTIONS_PAT }}@github.com/${{ github.repository }}.git
          git ls-remote --heads origin >/dev/null 2>&1 || true
          
          # Push to update the branch
          git push --force-with-lease origin "$BRANCH_NAME" || git push --force origin "$BRANCH_NAME"
          echo "‚úÖ Updated branch: $BRANCH_NAME"
          
          # Store branch name for PR creation
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      - name: Create or Update PR
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_PAT }}
        run: |
          echo "üîç Checking for existing PR on branch: $BRANCH_NAME"
          
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "‚úÖ PR #$EXISTING_PR already exists, updating..."
            gh pr edit "$EXISTING_PR" \
              --title "Homework Help: ${{ github.event.inputs.course }} ${{ github.event.inputs.assignment }}" \
              --body-file SYNTHESIS.md \
              --add-label "${{ github.event.inputs.category }}" 2>/dev/null || true
            echo "‚úÖ PR #$EXISTING_PR updated"
          else
            echo "üÜï Creating new PR..."
            if gh pr create \
              --title "Homework Help: ${{ github.event.inputs.course }} ${{ github.event.inputs.assignment }}" \
              --body-file SYNTHESIS.md \
              --base main \
              --head "$BRANCH_NAME" \
              --label "${{ github.event.inputs.category }}" 2>/dev/null; then
              echo "‚úÖ PR created successfully"
            else
              echo "‚ö†Ô∏è  Could not create PR automatically. Please create manually:"
              echo "   Branch: $BRANCH_NAME"
              echo "   Title: Homework Help: ${{ github.event.inputs.course }} ${{ github.event.inputs.assignment }}"
              echo "   URL: https://github.com/${{ github.repository }}/compare/main...$BRANCH_NAME"
            fi
          fi
